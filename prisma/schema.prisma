// This is your Prisma schema file. Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoleType {
  OWNER
  ADMIN
  MENTOR
  MENTEE
}

//This message type is defined with respect to the system (not the mentee)
enum MessageType {
  SENT
  RECEIVED
}

model User {
  id           String       @id @default(uuid())
  name         String
  username     String       @unique
  password     String?
  imageUrl     String?
  isDeleted    Boolean       @default(false) 
  createdAt    DateTime      @default(now())
  updatedAt    DateTime?     @updatedAt

  mentors      Mentor[]      @relation("UserToMentors")
  mentees      Mentee[]      @relation("UserToMentees")
  Message      Message[]     @relation("UserToMessages")
  admin        Admin?        @relation("UserToAdmins")
  accountUsers AccountUser[] @relation("UserToAccountUsers")
  
  @@index([username, isDeleted])
}

model Mentor {
  id             String          @id @default(uuid())
  userId         String          @unique
  expertise      String
  availability   Json
  age            Int
  gender         String
  location       String
  isActive       Boolean         @default(false)
  phone          String
  isDeleted      Boolean         @default(false) 
  createdAt      DateTime        @default(now())
  updatedAt      DateTime?       @updatedAt
  
  user           User            @relation("UserToMentors", fields: [userId], references: [id])
  conversations  Conversation[]  @relation("MentorToConversations")
  
  @@index([userId, isDeleted])
}

model Mentee {
  id             String          @id @default(uuid())
  userId         String          @unique
  metadata       Json
  isDeleted      Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime?       @updatedAt
  
  user           User            @relation("UserToMentees", fields: [userId], references: [id])
  conversations  Conversation[]  @relation("MenteeToConversations")
  
  @@index([userId, isDeleted])
}

model Admin {
  id             String          @id @default(uuid())
  userId         String          @unique
  phone          String
  gender         String
  age            Int
  location       String
  isActive       Boolean         @default(false)
  isDeleted      Boolean         @default(false)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime?       @updatedAt
  
  user           User            @relation("UserToAdmins", fields: [userId], references: [id])
 
  @@index([userId, isDeleted])
}

model Conversation {
  id             String          @id @default(uuid())
  mentorId       String
  menteeId       String
  channelId      String
  isActive       Boolean
  createdAt      DateTime        @default(now())
  endedAt        DateTime?

  mentor         Mentor          @relation("MentorToConversations", fields: [mentorId], references: [id])
  mentee         Mentee          @relation("MenteeToConversations", fields: [menteeId], references: [id])
  channel        Channel         @relation("ChannelToConversations", fields: [channelId], references: [id])
  threads        Thread[]        @relation("ConversationToThreads")
  
  @@index([mentorId, menteeId])
}

model Thread {
  id             String          @id @default(uuid())
  conversationId String
  messageId      String

  conversation   Conversation    @relation("ConversationToThreads", fields: [conversationId], references: [id])
  message        Message         @relation("MessageToThreads", fields: [messageId], references: [id])
  
  @@index([conversationId])
}

model Message {
  id             String          @id @default(uuid())
  channelId      String
  senderId       String
  type           MessageType
  content        String
  isDeleted      Boolean         @default(false) 
  createdAt      DateTime        @default(now())

  channel        Channel         @relation("ChannelToMessages", fields: [channelId], references: [id])
  sender         User            @relation("UserToMessages", fields: [senderId], references: [id])
  Thread         Thread[]        @relation("MessageToThreads")
  
  @@index([channelId, isDeleted])
  @@index([isDeleted, senderId]) 
}

model Account {
  id            String           @id @default(uuid())
  name          String           @unique
  domain        String?
  isDeleted     Boolean          @default(false) 
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  
  roles         Role[]           @relation("AccountToRoles")
  accountUsers  AccountUser[]    @relation("AccountToAccountUsers")
  channels      Channel[]        @relation("AccountToChannels")
 
  @@index([isDeleted, name])
}

model AccountUser {
  id           String           @id @default(uuid())
  userId       String
  accountId    String
  roleId       String
  isDeleted    Boolean          @default(false) 
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  account      Account          @relation("AccountToAccountUsers", fields: [accountId], references: [id])
  user         User             @relation("UserToAccountUsers", fields: [userId], references: [id])
  role         Role             @relation("AccountToAccountUsers", fields: [roleId], references: [id])

  @@index([userId, isDeleted]) 
  @@index([accountId, isDeleted])
}

model Role {
  id           String           @id @default(uuid())
  name         String
  type         RoleType
  isDefault    Boolean          @default(false)
  accountId    String?
  createdAt    DateTime         @default(now())

  account      Account?         @relation("AccountToRoles", fields: [accountId], references: [id])
  accountUsers AccountUser[]    @relation("AccountToAccountUsers")
}

model Channel {
  id             String          @id @default(uuid())
  accountId      String
  name           String
  configuration  Json
  isDeleted      Boolean         @default(false) 
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  account        Account         @relation("AccountToChannels", fields: [accountId], references: [id])
  conversations  Conversation[]  @relation("ChannelToConversations")
  messages       Message[]       @relation("ChannelToMessages")

  @@index([accountId, isDeleted])
}
